<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StudyFlow - Ultimate Fixed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- 1. æ ¸å¿ƒè®Šæ•¸ --- */
        :root {
            --bg-body: #F2F2F7;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --accent: #000000;
            --ultra-orange: #FF4F00;
            --sc-orange: #ff5500;
            --shadow: 0 8px 24px rgba(0,0,0,0.06);
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* å‹•ç•« */
        @keyframes pageEnter { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 80% { transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 2. å°è¦½åˆ— --- */
        .sidebar { width: 260px; background: rgba(255,255,255,0.85); backdrop-filter: blur(30px); border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; padding: 32px 20px; z-index: 20; }
        .logo { font-size: 22px; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; animation: popIn 0.8s var(--ease-bounce); }
        .nav-item { display: flex; align-items: center; padding: 14px 16px; color: var(--text-sub); border-radius: 14px; cursor: pointer; transition: 0.2s; font-weight: 600; margin-bottom: 8px; }
        .nav-item:hover { background: rgba(0,0,0,0.04); color: var(--text-main); transform: translateX(5px); }
        .nav-item.active { background: #000; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: scale(1.02); }
        .nav-item i { margin-right: 14px; width: 20px; text-align: center; }

        .main-content { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .content-wrap { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: pageEnter 0.5s var(--ease-bounce); }

        /* --- 3. ç•ªèŒ„é˜ (ä¿®å¾©ç‰ˆ) --- */
        .dash-split { display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; }
        .pomo-card { 
            background: white; padding: 30px; border-radius: 28px; 
            text-align: center; box-shadow: var(--shadow); 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; min-height: 400px;
        }
        .timer-svg-container { position: relative; width: 220px; height: 220px; margin: 20px 0; display: flex; align-items: center; justify-content: center; }
        .timer-svg { transform: rotate(-90deg); width: 220px; height: 220px; }
        .ring-track { fill: none; stroke: #E5E5EA; stroke-width: 12; }
        .ring-prog { fill: none; stroke: var(--ultra-orange); stroke-width: 12; stroke-linecap: round; stroke-dasharray: 691; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
        .timer-txt { position: absolute; font-size: 52px; font-weight: 800; letter-spacing: -1px; color: #1C1C1E; }
        .pomo-controls { display: flex; gap: 20px; align-items: center; margin-top: 10px; }
        .btn-circle { width: 56px; height: 56px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-grey { background: #F2F2F7; color: #1C1C1E; }
        .btn-play { background: #1C1C1E; color: white; width: 72px; height: 72px; font-size: 28px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .time-slider { -webkit-appearance: none; width: 80%; height: 6px; background: #E5E5EA; border-radius: 3px; outline: none; margin-top: 30px; }
        .time-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: white; border: 2px solid #E5E5EA; box-shadow: 0 2px 6px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }

        /* --- 4. çµ±è¨ˆèˆ‡é¦–é å…ƒä»¶ (ä¿®å¾©ç‰ˆ) --- */
        .stat-header-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-box { background: white; border-radius: 24px; padding: 20px; box-shadow: var(--shadow); height: 130px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; transition: 0.3s; }
        .stat-box:hover { transform: translateY(-3px); }
        .sb-val { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
        .sb-label { font-size: 13px; font-weight: 600; color: #888; }
        .sb-primary { background: #1C1C1E; color: white; } .sb-primary .sb-label { color: rgba(255,255,255,0.6); }

        .stat-mid-split { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px; }
        .chart-card, .subj-list-container { background: white; border-radius: 24px; padding: 24px; box-shadow: var(--shadow); height: 380px; display: flex; flex-direction: column; animation: slideUp 0.6s; }
        .subj-list { flex: 1; overflow-y: auto; padding-right: 5px; margin-top: 10px; }
        .subj-item { margin-bottom: 18px; animation: slideUp 0.5s; }
        .subj-info { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
        .subj-name { font-weight: 700; font-size: 15px; color: #1C1C1E; }
        .subj-time { font-weight: 600; font-size: 13px; color: #8E8E93; }
        .subj-bar-bg { width: 100%; height: 10px; background: #F2F2F7; border-radius: 6px; overflow: hidden; }
        .subj-bar-fill { height: 100%; background: #1C1C1E; border-radius: 6px; width: 0%; transition: width 1s; }

        /* --- 5. è³‡æºåˆ—è¡¨ --- */
        .res-input-card { background: white; padding: 20px; border-radius: 18px; box-shadow: var(--shadow); margin-bottom: 24px; animation: slideUp 0.4s; }
        .link-list { display: flex; flex-direction: column; gap: 12px; }
        .link-card { 
            background: white; border-radius: 18px; padding: 16px; position: relative;
            box-shadow: var(--shadow); transition: 0.2s; display: flex; align-items: center;
            cursor: pointer; animation: slideUp 0.3s;
        }
        .link-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .link-icon { width: 44px; height: 44px; background: #F2F2F7; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #1C1C1E; margin-right: 16px; }
        .link-info { flex: 1; overflow: hidden; }
        .link-name { font-size: 15px; font-weight: 600; color: #1C1C1E; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .link-url { font-size: 12px; color: #8E8E93; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .link-badge { font-size: 10px; padding: 3px 8px; border-radius: 6px; margin-left: 8px; font-weight: 700; display: inline-block; vertical-align: middle; }
        .bdg-drive { background: #E8F0FE; color: #1967D2; }
        .bdg-yt { background: #FFEBEB; color: #CC0000; }
        .link-del { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: #ddd; border-radius: 50%; transition: 0.2s; z-index: 5; margin-left: 10px; }
        .link-del:hover { background: #FFF0E6; color: #FF3B30; }

        /* PDF Modal */
        .pdf-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); opacity: 0; transition: 0.3s; }
        .pdf-modal-overlay.show { opacity: 1; }
        .pdf-container { width: 90%; height: 90%; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative; transform: scale(0.95); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; flex-direction: column; }
        .pdf-modal-overlay.show .pdf-container { transform: scale(1); }
        .pdf-header { height: 50px; background: #1C1C1E; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: white; flex-shrink: 0; }
        .pdf-close-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        iframe.pdf-frame { width: 100%; height: 100%; border: none; background: #fff; flex: 1; }

        /* å…¶ä»–é€šç”¨ */
        .task-row { display: flex; align-items: center; padding: 16px; background: white; border-radius: 16px; margin-bottom: 12px; box-shadow: var(--shadow); animation: slideUp 0.3s; }
        .check-circle { width: 24px; height: 24px; border: 2px solid #D1D1D6; border-radius: 50%; margin-right: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .check-circle.checked { background: #000; border-color: #000; color: white; }
        .btn-black { background: #000; color: white; padding: 12px 20px; border-radius: 14px; border: none; font-weight: 600; cursor: pointer; }
        .inp { width: 100%; padding: 14px; background: white; border: 1px solid #eee; border-radius: 14px; margin-bottom: 12px; outline: none; }
        .sc-card { background: white; border-radius: 24px; padding: 24px; box-shadow: var(--shadow); margin-bottom: 24px; }
        .preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; }
        .preset-btn { background: #F2F2F7; border: none; padding: 16px; border-radius: 16px; font-weight: 600; color: #333; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 13px; }

        /* Mobile Responsive */
        .mobile-header, .bottom-nav { display: none; }
        @media (max-width: 768px) {
            .sidebar { display: none !important; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; padding-top: max(10px, var(--safe-top)); background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); position: fixed; top: 0; width: 100%; z-index: 50; border-bottom: 1px solid rgba(0,0,0,0.05); }
            .bottom-nav { display: flex; justify-content: space-around; position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(25px); border-top: 1px solid #eee; padding-bottom: var(--safe-bottom); height: calc(65px + var(--safe-bottom)); z-index: 100; }
            .b-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #999; flex:1; } 
            .b-nav-item.active { color: #000; } .b-nav-item i { font-size: 22px; margin-bottom: 4px; }
            .content-wrap { padding: 20px; padding-top: 80px; padding-bottom: 100px; }
            .stat-header-grid { grid-template-columns: 1fr 1fr; gap: 12px; } .dash-split { display: flex; flex-direction: column; gap: 20px; }
            .stat-mid-split { display: flex; flex-direction: column; }
            .pdf-container { width: 100%; height: 100%; border-radius: 0; }
        }

        /* AI & Modals */
        .ai-fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #000; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 90; }
        .ai-win { position: fixed; bottom: 100px; right: 30px; width: 360px; height: 500px; background: white; border-radius: 20px; box-shadow: 0 30px 80px rgba(0,0,0,0.25); display: flex; flex-direction: column; transform: translateY(40px) scale(0.9); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; border: 1px solid #eee; }
        .ai-win.open { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 3000; opacity: 0; transition: 0.3s; backdrop-filter: blur(5px); }
        .modal-overlay.show { opacity: 1; }
        .modal { background: white; width: 360px; padding: 28px; border-radius: 24px; transform: scale(0.9); transition: 0.3s; }

        /* è¿”å›æŒ‰éˆ•æ¨£å¼ï¼ˆå°è€Œæ‰ï¼‰ */
        .back-btn { background:#F2F2F7; border:none; padding:6px 10px; border-radius:10px; font-weight:700; cursor:pointer; color:var(--text-main); box-shadow: none; }
        .back-btn:hover { background:#EDEDED; }
        .pdf-back-btn { background: rgba(255,255,255,0.08); border:none; color: white; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:700; }

        /* ç§‘ç›®å¿«æ·æŒ‰éˆ•ï¼ˆé è¨­è‰²ç”± JS inline style è¨­å®šï¼‰ */
        .subj-chip {
            border: none;
            padding: 8px 12px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: transform .12s, box-shadow .12s, opacity .12s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .subj-chip:active { transform: translateY(1px) scale(.99); }
        .subj-chip.active {
            background: #1C1C1E !important;
            color: #fff !important;
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }

        /* --- å…¶ä»–è‡ªè¨‚æ¨£å¼ --- */
        /* ...existing custom styles... */
    </style>
</head>
<body>

<div class="mobile-header">
    <div style="font-size:18px; font-weight:800; display:flex; align-items:center; gap:8px;"><i class="fa-brands fa-apple"></i> StudyFlow</div>
    <div id="m-auth-btn" onclick="app.auth.login()" style="width:36px; height:36px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center; overflow:hidden;"><i class="fa-solid fa-user" style="color:#999;"></i></div>
</div>

<nav class="sidebar">
    <div class="logo"><i class="fa-brands fa-apple"></i> StudyFlow</div>
    <div class="nav-item active" data-target="home" onclick="app.nav('home')"><i class="fa-solid fa-house"></i> é¦–é </div>
    <div class="nav-item" data-target="resources" onclick="app.nav('resources')"><i class="fa-solid fa-folder-open"></i> è¬›ç¾©è³‡æº</div>
    <div class="nav-item" data-target="music" onclick="app.nav('music')"><i class="fa-solid fa-music"></i> éŸ³æ¨‚</div>
    <div class="nav-item" data-target="tasks" onclick="app.nav('tasks')"><i class="fa-solid fa-check-circle"></i> ä»»å‹™</div>
    <div class="nav-item" data-target="schedule" onclick="app.nav('schedule')"><i class="fa-solid fa-calendar-week"></i> èª²è¡¨</div>
    <div class="nav-item" data-target="calendar" onclick="app.nav('calendar')"><i class="fa-regular fa-calendar"></i> è¡Œäº‹æ›†</div>
    <div class="nav-item" data-target="stats" onclick="app.nav('stats')"><i class="fa-solid fa-chart-simple"></i> çµ±è¨ˆ</div>
    <div class="nav-item" data-target="about" onclick="app.nav('about')"><i class="fa-solid fa-user-circle"></i> ä½œè€…ä»‹ç´¹</div>
    <div style="margin-top:auto; display:flex; align-items:center; gap:12px; padding-top:20px; border-top:1px solid rgba(0,0,0,0.05);">
        <div style="display:flex; align-items:center; gap:12px;">
            <div id="d-auth-btn" onclick="app.auth.login()" style="width:36px; height:36px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center; overflow:hidden; cursor:pointer;"><i class="fa-solid fa-user" style="color:#999; font-size:14px;"></i></div>
            <div id="u-name-d" onclick="app.auth.login()" style="font-size:14px; font-weight:700; cursor:pointer;">ç™»å…¥åŒæ­¥</div>
        </div>
        <div style="display:flex; gap:8px; margin-left:auto;">
            <button class="btn-grey" style="padding:8px 10px; border-radius:12px; font-weight:700;" onclick="app.exportData()">åŒ¯å‡º</button>
            <button class="btn-grey" style="padding:8px 10px; border-radius:12px; font-weight:700;" onclick="app.importFromFS()">åŒ¯å…¥</button>
        </div>
    </div>
</nav>

<main class="main-content">
    <div class="content-wrap">
        
        <div id="home" class="view-section active">
            <div class="header">
                <h1 id="date-display"></h1>
                <div id="live-clock" style="font-size:18px; color:#666; font-weight:700; margin-bottom:6px;"></div>
                <p style="color:#888;">å°ˆæ³¨ç•¶ä¸‹ï¼Œç©å°‘æˆå¤šã€‚</p>
            </div>
            <div class="stat-header-grid">
                <div class="stat-box sb-primary"><div class="sb-label" style="opacity:0.8">ä»Šæ—¥ä»»å‹™</div><div class="sb-val" id="d-done">0/0</div></div>
                <div class="stat-box"><div class="sb-label">å¾…è¾¦äº‹é …</div><div class="sb-val" id="d-todo">0</div></div>
                <div class="stat-box"><div class="sb-label">ä»Šæ—¥å°ˆæ³¨</div><div class="sb-val" id="d-focus">0m</div></div>
                <div class="stat-box"><div class="sb-label">é€£çºŒç™»å…¥</div><div class="sb-val" id="d-hist-len">0å¤©</div></div>
            </div>
            
            <div class="dash-split">
                <div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;"><h3>è¿‘æœŸä»»å‹™</h3><button class="btn-black" onclick="app.modals.open('task')">ï¼‹</button></div>
                    <div id="dash-tasks"></div>
                </div>
                
                <div class="pomo-card">
                    <div style="font-size:12px; font-weight:700; color:#ccc; letter-spacing:1px; margin-bottom:10px;">ULTRA FOCUS</div>
                    <div class="timer-svg-container">
                        <svg class="timer-svg" viewBox="0 0 240 240">
                            <circle class="ring-track" cx="120" cy="120" r="110"></circle>
                            <circle id="pomo-ring" class="ring-prog" cx="120" cy="120" r="110"></circle>
                        </svg>
                        <div class="timer-txt" id="timer-display">25:00</div>
                    </div>
                    <div class="pomo-controls">
                        <button class="btn-circle btn-grey" onclick="app.timer.reset()"><i class="fa-solid fa-rotate-left"></i></button>
                        <button class="btn-circle btn-play" id="btn-play" onclick="app.timer.toggle()"><i class="fa-solid fa-play"></i></button>
                    </div>
                    <div id="pomo-subj-chips" style="display:flex; gap:8px; margin-top:16px; flex-wrap:wrap; justify-content:center;"></div>
                     <input type="range" class="time-slider" min="5" max="120" step="5" value="25" oninput="app.timer.setDuration(this.value)">
                </div>
            </div>
        </div>

        <div id="resources" class="view-section">
            <div class="header"><h1>è¬›ç¾©è³‡æº</h1><p>è²¼ä¸Š Drive é€£çµï¼Œè‡ªå‹•è½‰ç‚ºé–±è®€å™¨</p></div>
            <div class="res-input-card">
                <input id="res-name" class="inp" placeholder="åç¨± (ä¾‹å¦‚: ç‰©ç†Ch1 è¬›ç¾©)">
                <input id="res-url" class="inp" placeholder="è²¼ä¸Š Google Drive å…±ç”¨é€£çµ..." style="margin-bottom:10px;">
                <button class="btn-black" style="width:100%;" onclick="app.resources.add()">ï¼‹ æ–°å¢è³‡æº</button>
                <div style="font-size:12px; color:#888; margin-top:10px; text-align:center;">ğŸ’¡ æç¤ºï¼šDrive æª”æ¡ˆæ¬Šé™è«‹è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä½¿ç”¨è€…çš†å¯æª¢è¦–ã€</div>
            </div>
            <h3 style="margin-bottom:10px;">æˆ‘çš„è³‡æºåº«</h3>
            <div id="res-list" class="link-list"></div>
        </div>

        <div id="music" class="view-section">
            <div class="header"><h1>å°ˆæ³¨éŸ³æ¨‚</h1></div>
            <div class="sc-card">
                <div style="margin-bottom:15px; font-weight:700; color:var(--sc-orange);"><i class="fa-brands fa-soundcloud"></i> SoundCloud Player</div>
                <iframe id="sc-iframe" width="100%" height="320" scrolling="no" frameborder="no" allow="autoplay"
    src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/lofi-girl-805623086/sets/lofi-girl-favorites&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe>
                <!-- æ’­æ”¾æ¬„ä½åŠ å¤§ -->
                <div style="display:flex; gap:12px; margin:24px 0;">
                    <input id="sc-custom-url" class="inp" style="flex:1; margin-bottom:0; height:48px; font-size:18px;" placeholder="è¼¸å…¥ SoundCloud é€£çµ...">
                    <button class="btn-black" style="height:48px; font-size:18px; padding:0 24px;" onclick="app.soundcloud.load(document.getElementById('sc-custom-url').value)">æ’­æ”¾</button>
                </div>
                <!-- ...existing code... -->
                <div class="preset-grid">
                    <button class="preset-btn" onclick="app.soundcloud.load('https://soundcloud.com/lofi-girl-805623086/sets/lofi-girl-favorites')"><i class="fa-solid fa-mug-hot"></i> Lo-Fi Girl</button>
                    <button class="preset-btn" onclick="app.soundcloud.load('https://soundcloud.com/user-969796068/sets/classical-study-music')"><i class="fa-solid fa-piano"></i> å¤å…¸é‹¼ç´</button>
                    <button class="preset-btn" onclick="app.soundcloud.load('https://soundcloud.com/relaxdaily/sets/relaxing-music-calm-piano')"><i class="fa-solid fa-wind"></i> æ”¾é¬†æ°›åœ</button>
                </div>
            </div>
        </div>

        <div id="tasks" class="view-section">
            <div class="header"><h1>ä»»å‹™æ¸…å–®</h1></div>
            <div style="display:flex; gap:10px; margin-bottom:20px;"><input class="inp" style="margin:0;" placeholder="æœå°‹..." oninput="app.tasks.setSearch(this.value)"><button class="btn-black" onclick="app.modals.open('task')">ï¼‹</button></div>
            <div id="full-task-list"></div>
        </div>

        <div id="schedule" class="view-section">
            <div class="header"><h1>æˆ‘çš„èª²è¡¨</h1><button class="btn-black" style="padding:6px 12px; font-size:12px;" onclick="app.modals.open('c')">ï¼‹ èª²ç¨‹</button></div>
            <div style="background:white; border-radius:24px; overflow-x:auto; padding-bottom:10px; box-shadow:var(--shadow);"><div id="sch-grid" style="display:grid; grid-template-columns: 40px repeat(7, minmax(70px, 1fr)); min-width:600px;"></div></div>
        </div>

        <div id="calendar" class="view-section">
            <div class="header"><h1>è¡Œäº‹æ›†</h1></div>
            <div style="background:white; padding:24px; border-radius:24px; box-shadow:var(--shadow);">
                 <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;"><h2 id="cal-title">...</h2><div><button class="btn-black" onclick="app.cal.move(-1)"><</button> <button class="btn-black" onclick="app.cal.move(1)">></button></div></div>
                <div id="cal-body" style="display:grid; grid-template-columns:repeat(7,1fr); gap:10px;"></div>
            </div>
        </div>

        <div id="stats" class="view-section">
            <div class="header"><h1>å­¸ç¿’çµ±è¨ˆ</h1><p>æ•¸æ“šåˆ†æ</p></div>
            
            <div class="stat-header-grid">
                <div class="stat-box sb-primary"><div class="sb-label">ä»Šæ—¥å­¸ç¿’</div><div class="sb-val" id="s-today">0m</div></div>
                <div class="stat-box"><div class="sb-label">æœ¬é€±å­¸ç¿’</div><div class="sb-val" id="s-week">0h</div></div>
                <div class="stat-box"><div class="sb-label">é€£çºŒå­¸ç¿’</div><div class="sb-val" id="s-streak">0å¤©</div></div>
                <div class="stat-box"><div class="sb-label">å®Œæˆç‡</div><div class="sb-val" id="s-rate">0%</div></div>
            </div>

            <div class="stat-mid-split">
                <div class="chart-card">
                    <h3 style="margin-bottom:20px; font-size:18px;">éå»7å¤©å­¸ç¿’è¶¨å‹¢</h3>
                    <div style="flex:1; position:relative;"><canvas id="chartTrend"></canvas></div>
                </div>
                <div class="subj-list-container">
                    <h3 style="margin-bottom:20px; font-size:18px;">ç§‘ç›®åˆ†ä½ˆæ’è¡Œæ¦œ</h3>
                    <div class="subj-list" id="stat-subj-list"></div>
                </div>
            </div>
        </div>

        <div id="about" class="view-section">
            <div class="header"><h1>ä½œè€…ä»‹ç´¹</h1><p>äº†è§£æ›´å¤šé—œæ–¼ä½œè€…çš„è³‡è¨Šã€‚</p></div>
            <div style="background:white; border-radius:24px; overflow:hidden; box-shadow:var(--shadow);">
                <iframe src="è‡ªä»‹ç¶²ç«™.html" style="width:100%; height:600px; border:none;"></iframe>
            </div>
        </div>

    </div>
</main>

<nav class="bottom-nav">
    <div class="b-nav-item active" data-target="home" onclick="app.nav('home')"><i class="fa-solid fa-house"></i> é¦–é </div>
    <div class="b-nav-item" data-target="resources" onclick="app.nav('resources')"><i class="fa-solid fa-folder-open"></i> è³‡æº</div>
    <div class="b-nav-item" data-target="music" onclick="app.nav('music')"><i class="fa-solid fa-music"></i> éŸ³æ¨‚</div>
    <div class="b-nav-item" data-target="tasks" onclick="app.nav('tasks')"><i class="fa-solid fa-check-circle"></i> ä»»å‹™</div>
    <div class="b-nav-item" data-target="schedule" onclick="app.nav('schedule')"><i class="fa-solid fa-calendar-week"></i> èª²è¡¨</div>
    <div class="b-nav-item" data-target="about" onclick="app.nav('about')"><i class="fa-solid fa-user-circle"></i> ä»‹ç´¹</div>
</nav>

<div class="ai-fab" onclick="document.getElementById('ai-win').classList.add('open')"><i class="fa-solid fa-robot"></i></div>
<div class="ai-win" id="ai-win">
    <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <button class="back-btn" onclick="document.getElementById('ai-win').classList.remove('open')">â† è¿”å›</button>
        <b>AI åŠ©æ‰‹</b>
        <i class="fa-solid fa-xmark" onclick="document.getElementById('ai-win').classList.remove('open')" style="cursor:pointer;"></i>
    </div>
    <div id="ai-chat" style="flex:1; padding:15px; overflow-y:auto; background:#f9f9f9;"></div>
    <div style="padding:15px; display:flex; gap:10px;"><input id="ai-input" class="inp" style="margin:0;" placeholder="è¼¸å…¥å•é¡Œ..."><button class="btn-black" onclick="app.ai.send()">â†’</button></div>
</div>

<div class="modal-overlay" id="modal-overlay"><div class="modal" id="modal-content"></div></div>

<div id="pdf-viewer" class="pdf-modal-overlay">
    <div class="pdf-container">
        <div class="pdf-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="pdf-back-btn" onclick="app.viewer.close()">â† è¿”å›</button>
                <span id="pdf-title" style="font-weight:600; font-size:14px;">æ–‡ä»¶é è¦½</span>
            </div>
            <button class="pdf-close-btn" onclick="app.viewer.close()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <iframe id="pdf-frame" class="pdf-frame" src="" allow="autoplay"></iframe>
    </div>
</div>

<!-- æ–°å¢éš±è—æª”æ¡ˆè¼¸å…¥ï¼ˆæ”¾åœ¨ body çµå°¾é™„è¿‘ï¼‰ -->
<input type="file" id="__import_file" accept="application/json" style="display:none" onchange="app.importFromFile(event)">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyD9LW-VQo8ejMq1dYCC9WhdmakUXR17q9I", authDomain: "studydatabase-29aaf.firebaseapp.com", projectId: "studydatabase-29aaf", appId: "1:781290296072:web:4a8894785a0cd4cb00d2bd" };
    
    // åˆå§‹åŒ–
    const appBase = initializeApp(firebaseConfig);
    const db = getFirestore(appBase);
    const auth = getAuth(appBase);

    // æ›è¼‰å…¨åŸŸè®Šæ•¸
    window.app = window.app || {};
    window.app.db = db;
    window.app.authObj = auth;
    window.app.doc = doc;
    window.app.setDoc = setDoc;
    window.app.provider = new GoogleAuthProvider();
    window.app.signOut = signOut;
    window.app.signInWithPopup = signInWithPopup;

    onAuthStateChanged(auth, u=>{ 
        window.app.currentUser=u; 
        window.app.updateAuthUI(u); 
        if(u) {
            onSnapshot(doc(db,"users",u.uid), s=>{
                if(s.exists()){
                    window.app.data={...window.app.data,...s.data()};
                    if(!window.app.data.resources) window.app.data.resources = [];
                    // ç¢ºä¿æ­·å²ç´€éŒ„å­˜åœ¨
                    if(!window.app.data.history) window.app.data.history = [];
                    // ç¢ºä¿ events å­˜åœ¨
                    if(!window.app.data.events) window.app.data.events = [];
                    // ç¢ºä¿ subjects å­˜åœ¨
                    if(!window.app.data.stats.subjects) window.app.data.stats.subjects = {'æ•¸å­¸':0,'è‹±æ–‡':0,'ç‰©ç†':0,'ç¨‹å¼':0,'å…¶ä»–':0};
                    
                    window.app.checkDailyReset(); // ç™»å…¥æˆ–æ•¸æ“šè®Šæ›´æ™‚æª¢æŸ¥æ—¥æœŸ
                    window.app.refreshAll();
                } else window.cloudSave();
            });
        }
    });

    window.cloudSave = async () => {
        if(window.app.currentUser && window.app.data) {
            await setDoc(doc(db, "users", window.app.currentUser.uid), window.app.data, {merge:true});
        }
        window.app.refreshAll();
    };
</script>

<script>
    window.app = window.app || {};
    window.app = {
        data: { tasks:[], courses:[], resources:[], events:[], stats:{focusToday:0, subjects:{'æ•¸å­¸':0,'è‹±æ–‡':0,'ç‰©ç†':0,'ç¨‹å¼':0,'å…¶ä»–':0}}, history:[], lastActiveDate:'' }, 
        
        init: function() {
            this.updateDate(); this.timer.init(); this.chart.init(); this.refreshAll();
            document.getElementById('modal-overlay').addEventListener('click',e=>{if(e.target.id==='modal-overlay')app.modals.close()});
        },

        // --- æ ¸å¿ƒä¿®å¾©ï¼šæ¯æ—¥é‡ç½® & é€£çºŒç™»å…¥è¨ˆç®— ---
        checkDailyReset: function() {
            const today = new Date().toISOString().split('T')[0];
            const last = app.data.lastActiveDate;
            
            // å¦‚æœä¸Šæ¬¡æ´»èºæ—¥æœŸä¸æ˜¯ä»Šå¤©ï¼Œä¸”ä¸Šæ¬¡æœ‰æ—¥æœŸ (ä¸æ˜¯ç¬¬ä¸€æ¬¡ç”¨)
            if(last && last !== today) {
                // å°‡æ˜¨å¤©çš„æ•¸æ“šå­˜å…¥ History (åªå­˜ focus)
                app.data.history.push({ date: last, focus: app.data.stats.focusToday });
                
                // ä¿æŒ history åªç•™æœ€å¾Œ 30 å¤©
                if(app.data.history.length > 30) app.data.history.shift();

                // é‡ç½®ä»Šæ—¥æ•¸æ“š
                app.data.stats.focusToday = 0;
                // æ³¨æ„ï¼šsubjects ç´¯ç©é€šå¸¸ä¸é‡ç½®ï¼Œå¦‚æœè¦é‡ç½®æœ¬æ—¥ç§‘ç›®å‰‡é€™è¡Œè§£é–‹:
                // app.data.stats.subjects = {'æ•¸å­¸':0,'è‹±æ–‡':0,'ç‰©ç†':0,'ç¨‹å¼':0,'å…¶ä»–':0};
                
                app.data.lastActiveDate = today;
                window.cloudSave(); // å­˜å›é›²ç«¯
            } else if (!last) {
                app.data.lastActiveDate = today; // ç¬¬ä¸€æ¬¡ä½¿ç”¨
            }
        },

        calculateStreak: function() {
            if(!app.data.history) return 1;
            const today = new Date().toISOString().split('T')[0];
            let streak = 1; // ä»Šå¤©ç®— 1 å¤©
            
            // è¤‡è£½ä¸€ä»½ history ä¸¦åè½‰ï¼Œå¾æœ€è¿‘çš„æ—¥æœŸé–‹å§‹æª¢æŸ¥
            const historyRev = [...app.data.history].reverse();
            let checkDate = new Date(); // å¾æ˜¨å¤©é–‹å§‹æª¢æŸ¥
            
            for(let h of historyRev) {
                checkDate.setDate(checkDate.getDate() - 1);
                const targetStr = checkDate.toISOString().split('T')[0];
                if(h.date === targetStr) {
                    streak++;
                } else {
                    break; // æ–·æ‰äº†
                }
            }
            return streak;
        },

        refreshAll: function() { 
            this.tasks.render(); 
            this.schedule.render(); 
            this.cal.render(); 
            this.stats.render(); 
            this.resources.render(); 
            if(this.chart.instTrend) this.chart.updateTrend(); 
            if(this.timer && this.timer.renderSubjects) this.timer.renderSubjects();
        },

        updateAuthUI: function(u) {
            const h = u ? `<img src="${u.photoURL}" style="width:100%;height:100%;object-fit:cover;">` : `<i class="fa-solid fa-user"></i>`;
            const b1=document.getElementById('m-auth-btn'), b2=document.getElementById('d-auth-btn');
            if(b1)b1.innerHTML=h; if(b2)b2.innerHTML=h;
            if(u && document.getElementById('u-name-d')) document.getElementById('u-name-d').innerText = u.displayName;
        },

        auth: { 
            login:()=>{ 
                if(window.app.currentUser){if(confirm('ç™»å‡º?'))window.app.signOut(window.app.authObj)}
                else{window.app.signInWithPopup(window.app.authObj, window.app.provider).catch(alert);} 
            } 
        },

        nav: function(id) {
            document.querySelectorAll('.view-section').forEach(v=>v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item, .b-nav-item').forEach(n=>{ n.classList.remove('active'); if(n.dataset.target===id)n.classList.add('active'); });
        },

        resources: {
            add: function() {
                if(!window.app.currentUser) return alert("è«‹å…ˆç™»å…¥");
                const n = document.getElementById('res-name').value;
                const u = document.getElementById('res-url').value;
                if(!n || !u) return alert("è«‹è¼¸å…¥å®Œæ•´");

                let type = 'link', icon = 'fa-link';
                if(u.includes('drive.google.com')) { type='drive'; icon='fa-google-drive'; }
                else if(u.includes('youtube')||u.includes('youtu.be')) { type='video'; icon='fa-youtube'; }
                else if(u.endsWith('.pdf')) { type='pdf'; icon='fa-file-pdf'; }

                if(!app.data.resources) app.data.resources = [];
                app.data.resources.unshift({ id: Date.now(), name:n, url:u, type, icon });
                
                document.getElementById('res-name').value = '';
                document.getElementById('res-url').value = '';
                window.cloudSave();
            },
            del: function(id) {
                if(confirm('ç¢ºå®šåˆªé™¤?')) {
                    app.data.resources = app.data.resources.filter(r => r.id !== id);
                    window.cloudSave();
                }
            },
            render: function() {
                const list = document.getElementById('res-list');
                const data = app.data.resources || [];
                if(data.length === 0) { list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">å°šç„¡è³‡æº</div>'; return; }
                
                list.innerHTML = data.map(r => {
                    let action = `window.open('${r.url}','_blank')`;
                    let badge = '';
                    if(r.type === 'drive') {
                        const safeName = r.name.replace(/'/g, "\\'");
                        action = `app.viewer.open('${r.url}', '${safeName}')`;
                        badge = `<span class="link-badge bdg-drive">é è¦½ PDF</span>`;
                    } else if (r.type === 'video') {
                        badge = `<span class="link-badge bdg-yt">å½±ç‰‡</span>`;
                    }
                    return `
                    <div class="link-card">
                        <div class="link-icon" onclick="${action}"><i class="fa-brands ${r.icon}"></i></div>
                        <div class="link-info" onclick="${action}">
                            <div class="link-name">${r.name} ${badge}</div>
                            <div class="link-url">${r.url}</div>
                        </div>
                        <div class="link-del" onclick="app.resources.del(${r.id})"><i class="fa-solid fa-trash"></i></div>
                    </div>`;
                }).join('');
            }
        },

        viewer: {
            open: function(url, title) {
                let fileId = "";
                const m1 = url.match(/\/d\/(.*?)\//);
                const m2 = url.match(/id=(.*?)(&|$)/);
                if(m1) fileId = m1[1]; else if(m2) fileId = m2[1];

                if(!fileId) { window.open(url, '_blank'); return; }

                const previewUrl = `https://drive.google.com/file/d/${fileId}/preview`;
                document.getElementById('pdf-title').innerText = title;
                document.getElementById('pdf-frame').src = previewUrl;
                const m = document.getElementById('pdf-viewer');
                m.style.display = 'flex';
                setTimeout(()=>m.classList.add('show'), 10);
            },
            close: function() {
                const m = document.getElementById('pdf-viewer');
                m.classList.remove('show');
                setTimeout(()=>{ m.style.display='none'; document.getElementById('pdf-frame').src=''; }, 300);
            }
        },

        tasks: {
            render: function() {
                const all = app.data.tasks || [];
                const dList = document.getElementById('dash-tasks');
                const fList = document.getElementById('full-task-list');
                const todos = all.filter(t=>!t.done);
                
                const badgeFor = (p) => {
                    if(p==='é«˜') return `<span style="display:inline-block;padding:4px 8px;border-radius:8px;font-size:12px;font-weight:700;background:#FFD6D6;color:#B00000;margin-left:8px;">é«˜</span>`;
                    if(p==='ä¸­') return `<span style="display:inline-block;padding:4px 8px;border-radius:8px;font-size:12px;font-weight:700;background:#FFF4D6;color:#B36B00;margin-left:8px;">ä¸­</span>`;
                    return `<span style="display:inline-block;padding:4px 8px;border-radius:8px;font-size:12px;font-weight:700;background:#E8F5E9;color:#237A00;margin-left:8px;">ä½</span>`;
                };

                dList.innerHTML = todos.slice(0,3).map(t=>{
                    const b = badgeFor(t.priority||'ä¸­');
                    const est = t.est ? `<small style="color:#888;margin-left:8px">${t.est}m</small>` : '';
                    return `
                    <div class="task-row">
                        <div class="check-circle" onclick="app.tasks.toggle(${t.id})"></div>
                        <div style="font-weight:600; font-size:14px;">${t.title} ${b} ${est}</div>
                    </div>`;
                }).join('') || '<div style="text-align:center;color:#ccc;padding:10px;">ç„¡å¾…è¾¦äº‹é …</div>';

                fList.innerHTML = all.map(t=>{
                    const b = badgeFor(t.priority||'ä¸­');
                    const est = t.est ? `<div style="font-size:12px;color:#888;margin-top:6px;">é ä¼° ${t.est} åˆ†é˜</div>` : '';
                    return `
                    <div class="task-row">
                        <div class="check-circle ${t.done?'checked':''}" onclick="app.tasks.toggle(${t.id})"><i class="fa-solid fa-check" style="color:white;font-size:12px;display:${t.done?'block':'none'}"></i></div>
                        <div style="flex:1;">
                            <div style="font-weight:600; text-decoration:${t.done?'line-through':''}; color:${t.done?'#999':'#000'}">
                                ${t.title} ${b}
                            </div>
                            ${est}
                        </div>
                        <i class="fa-solid fa-trash" style="color:#ddd; padding:10px; cursor:pointer;" onclick="app.tasks.del(${t.id})"></i>
                    </div>`;
                }).join('');

                document.getElementById('d-todo').innerText = todos.length;
                document.getElementById('d-done').innerText = `${all.length-todos.length}/${all.length}`;
             },
             add: function() {
                const t = document.getElementById('t-title').value;
                const p = document.getElementById('t-priority') ? document.getElementById('t-priority').value : 'ä¸­';
                let e = parseInt(document.getElementById('t-est') ? document.getElementById('t-est').value : '0', 10);
                if(isNaN(e) || e < 0) e = 0;
                if(t) {
                    if(!app.data.tasks) app.data.tasks=[];
                    app.data.tasks.unshift({id:Date.now(), title:t, done:false, priority:p, est: e, created: Date.now()});
                    window.cloudSave(); app.modals.close();
                }
             },
             toggle: function(id) {
                 const t = app.data.tasks.find(x=>x.id===id);
                 if(t){ t.done=!t.done; if(t.done)confetti({particleCount:30,origin:{y:0.6},colors:['#000']}); window.cloudSave(); }
             },
             del: function(id) {
                 if(confirm('åˆªé™¤?')) { app.data.tasks=app.data.tasks.filter(x=>x.id!==id); window.cloudSave(); }
             },
             setSearch: function(v){}
         },

        timer: {
            time:1500, max:1500, int:null, active:false, subj:'å…¶ä»–',
            init: function(){ this.draw(); },
            setDuration: function(m){ if(!this.active){this.max=m*60; this.time=this.max; this.draw();} },
            toggle: function(){ 
                const btn=document.getElementById('btn-play');
                if(this.active){ clearInterval(this.int); this.active=false; btn.innerHTML='<i class="fa-solid fa-play"></i>'; }
                else { this.active=true; btn.innerHTML='<i class="fa-solid fa-pause"></i>'; this.int=setInterval(()=>{this.time--;this.draw();if(this.time<=0)this.finish()},1000)} 
            },
            finish: function(){ 
                this.active=false; clearInterval(this.int); confetti(); alert('å°ˆæ³¨å®Œæˆï¼'); 
                
                // å¢åŠ æ™‚é–“ï¼ˆä¾ç…§æ‰€é¸ç§‘ç›®ï¼‰
                const min = Math.floor(this.max/60);
                app.data.stats.focusToday += min;
                const sub = this.subj || 'å…¶ä»–';
                if(!app.data.stats.subjects[sub]) app.data.stats.subjects[sub] = 0;
                app.data.stats.subjects[sub] += min;

                window.cloudSave(); this.reset();
            },
            reset: function(){ clearInterval(this.int); this.active=false; this.time=this.max; document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-play"></i>'; this.draw(); },
            draw: function(){ 
                const m=Math.floor(this.time/60).toString().padStart(2,'0'), s=(this.time%60).toString().padStart(2,'0'); 
                document.getElementById('timer-display').innerText=`${m}:${s}`;
                const off = 691 - (this.time/this.max)*691; document.getElementById('pomo-ring').style.strokeDashoffset = off;
            },
            // å°‡ç§‘ç›®æ¸…å–®æ¸²æŸ“ç‚ºå¿«æ·æ¨™ç±¤ï¼ˆæŒ‰éˆ•ï¼Œä¾ç§‘ç›®æŒ‡å®šé¡è‰²ï¼‰
            renderSubjects: function(){
                const container = document.getElementById('pomo-subj-chips');
                if(!container) return;
                const subjects = app.data.stats && app.data.stats.subjects ? Object.keys(app.data.stats.subjects) : ['å…¶ä»–'];
                // ç§‘ç›®é¡è‰²å°æ‡‰ï¼Œå¯æŒ‰éœ€èª¿æ•´
                const colorMap = { 'æ•¸å­¸':'#FFD54F', 'è‹±æ–‡':'#4FC3F7', 'ç‰©ç†':'#81C784', 'ç¨‹å¼':'#B39DDB', 'å…¶ä»–':'#E0E0E0' };
                container.innerHTML = subjects.map(s=>{
                    const bg = colorMap[s] || '#E0E0E0';
                    const isActive = (this.subj === s);
                    const style = isActive ? `background:#1C1C1E;color:#fff;` : `background:${bg};color:${bg===' #E0E0E0'?'#1C1C1E':'#1C1C1E'};`;
                    const safe = s.replace(/'/g,"\\'");
                    return `<button type="button" class="subj-chip ${isActive?'active':''}" data-sub="${safe}" style="background:${isActive? '#1C1C1E' : bg}; color:${isActive? '#fff' : '#1C1C1E'}" onclick="app.timer.setSubject('${safe}')">${s}</button>`;
                }).join('');
            },
            setSubject: function(s){
                this.subj = s || 'å…¶ä»–';
                const chips = document.querySelectorAll('#pomo-subj-chips .subj-chip');
                chips.forEach(c=>{
                    const subName = c.getAttribute('data-sub');
                    const active = subName === this.subj;
                    c.classList.toggle('active', active);
                    if(active){
                        c.style.background = '#1C1C1E';
                        c.style.color = '#fff';
                    } else {
                        // ç¶­æŒ colorMap é…è‰²ï¼ˆfallbackï¼‰
                        const m = { 'æ•¸å­¸':'#FFD54F', 'è‹±æ–‡':'#4FC3F7', 'ç‰©ç†':'#81C784', 'ç¨‹å¼':'#B39DDB', 'å…¶ä»–':'#E0E0E0' };
                        c.style.background = m[subName] || '#E0E0E0';
                        c.style.color = '#1C1C1E';
                    }
                });
            }
         },
        schedule: {
            render: function(){
                const g=document.getElementById('sch-grid'); g.innerHTML=`<div></div>`+['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map(d=>`<div style="padding:5px;text-align:center;font-size:12px;color:#888;">${d}</div>`).join('');
                const t=document.createElement('div'); for(let i=8;i<=20;i++)t.innerHTML+=`<div style="height:60px;border-bottom:1px solid #eee;text-align:center;color:#999;font-size:10px;padding-top:5px;">${i}</div>`; g.appendChild(t);
                for(let d=1;d<=7;d++){
                    const c=document.createElement('div'); c.style.position='relative'; c.style.borderRight='1px solid #f5f5f7';
                    for(let h=8;h<=20;h++){const s=document.createElement('div');s.style.height='60px';s.style.borderBottom='1px solid #f9f9f9';c.appendChild(s);}
                    (app.data.courses||[]).filter(x=>x.day===d).forEach(x=>{ 
                        const b=document.createElement('div'); 
                        b.style.cssText=`position:absolute;left:2px;right:2px;padding:4px;border-radius:6px;font-size:10px;font-weight:700;background:#1D1D1F;color:white;top:${(x.start-8)*60}px;height:60px;overflow:hidden;cursor:pointer;`; 
                        b.innerHTML=x.name; 
                        b.onclick=()=>app.schedule.del(x.id);
                        c.appendChild(b); 
                    });
                    g.appendChild(c);
                }
            },
            add: function(){ 
                const n=document.getElementById('c-name').value; 
                if(n){ 
                    if(!app.data.courses) app.data.courses=[];
                    app.data.courses.push({id:Date.now(),name:n,day:parseInt(document.getElementById('c-day').value),start:parseFloat(document.getElementById('c-start').value)}); 
                    window.cloudSave(); app.modals.close(); 
                } 
            },
            del: function(id){ if(confirm('åˆªé™¤èª²ç¨‹?')){ app.data.courses=app.data.courses.filter(x=>x.id!==id); window.cloudSave(); } }
        },

        cal: {
            d:new Date(), move:function(n){this.d.setMonth(this.d.getMonth()+n);this.render()},
            render:function(){
                const y=this.d.getFullYear(), m=this.d.getMonth();
                document.getElementById('cal-title').innerText=`${y} / ${m+1}`;
                const g=document.getElementById('cal-body'); g.innerHTML='';
                const firstDay = new Date(y,m,1).getDay(), max=new Date(y,m+1,0).getDate();
                // ç©ºæ ¼
                for(let i=0;i<firstDay;i++) g.innerHTML += `<div></div>`;
                // æ¯æ—¥æ ¼
                for(let i=1;i<=max;i++){
                    const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const isToday = dateStr === new Date().toISOString().split('T')[0];
                    const evCount = (app.data.events||[]).filter(e=>e.date===dateStr).length;
                    g.innerHTML += `
                        <div onclick="app.modals.open('day','${dateStr}')" style="height:60px; padding:6px; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:10px; background:${isToday?'#000':'transparent'}; color:${isToday?'#fff':'#333'}; font-weight:${isToday?700:400}; cursor:pointer; position:relative;">
                            <div style="font-size:14px;">${i}</div>
                            <div style="position:absolute; bottom:6px; right:6px; font-size:11px; color:${isToday?'rgba(255,255,255,0.8)':'#888'}">${evCount?evCount+' ä»¶':''}</div>
                        </div>`;
                }
            }
        },

        // --- çµ±è¨ˆ (ä¿®å¾©ï¼šæ¢å¾©å››æ ¼ã€åœ–è¡¨èˆ‡ç§‘ç›®æ’è¡Œ) ---
        stats: {
            render: function() {
                const ft = app.data.stats.focusToday || 0;
                const tasks = app.data.tasks || [];
                const doneCount = tasks.filter(t=>t.done).length;
                const rate = tasks.length ? Math.round((doneCount/tasks.length)*100) : 0;
                
                // æœ¬é€±ç´¯è¨ˆ
                let weekTotal = ft;
                if(app.data.history) {
                    app.data.history.forEach(h => weekTotal += (h.focus || 0));
                }

                // å¯¦æ™‚è¨ˆç®—é€£çºŒç™»å…¥
                const streak = app.calculateStreak();

                document.getElementById('s-today').innerText = ft + 'm';
                document.getElementById('s-week').innerText = (weekTotal/60).toFixed(1) + 'h';
                document.getElementById('s-streak').innerText = streak + 'å¤©';
                document.getElementById('s-rate').innerText = rate + '%';
                
                // é¦–é åŒæ­¥
                document.getElementById('d-focus').innerText = ft + 'm';
                document.getElementById('d-hist-len').innerText = streak + 'å¤©';

                // æ¸²æŸ“ç§‘ç›®åˆ—è¡¨
                const list = document.getElementById('stat-subj-list');
                const subjs = app.data.stats.subjects || {};
                const totalS = Object.values(subjs).reduce((a,b)=>a+b, 0) || 1;
                const sorted = Object.entries(subjs).sort((a,b)=>b[1]-a[1]);
                
                list.innerHTML = sorted.map(([k, v])=>{
                    const p = Math.round((v/totalS)*100);
                    return `
                    <div class="subj-item">
                        <div class="subj-info"><span class="subj-name">${k}</span><span class="subj-time">${v}m (${p}%)</span></div>
                        <div class="subj-bar-bg"><div class="subj-bar-fill" style="width:${p}%"></div></div>
                    </div>`;
                }).join('');
            }
        },

        chart: {
            instTrend: null,
            init: function() {
                this.instTrend = new Chart(document.getElementById('chartTrend'), {
                    type: 'line',
                    data: { labels:['D-6','D-5','D-4','D-3','D-2','æ˜¨','ä»Š'], datasets:[{label:'åˆ†é˜', data:[0,0,0,0,0,0,0], borderColor:'#000', backgroundColor:'rgba(0,0,0,0.05)', fill:true, tension:0.4}] },
                    options: { maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
                });
            },
            updateTrend: function() {
                if(!this.instTrend) return;
                
                // å¾ history èˆ‡ä»Šå¤©è³‡æ–™æ§‹å»ºéå» 7 å¤©
                const today = new Date();
                const data = [];
                const hist = app.data.history || [];
                
                // è¿´åœˆéæ­·éå» 7 å¤©ï¼ˆå¾ D-6 åˆ° todayï¼‰
                for(let i=6; i>=0; i--) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    
                    // æŸ¥æ‰¾è©²å¤©çš„ history è¨˜éŒ„
                    const record = hist.find(h => h.date === dateStr);
                    
                    if(dateStr === new Date().toISOString().split('T')[0]) {
                        // ä»Šå¤©ï¼šç”¨ focusToday
                        data.push(app.data.stats.focusToday || 0);
                    } else if(record) {
                        // éå»æŸå¤©ï¼šç”¨ history çš„ focus
                        data.push(record.focus || 0);
                    } else {
                        // æ²’æœ‰è¨˜éŒ„çš„æ—¥æœŸï¼šç”¨ 0
                        data.push(0);
                    }
                }
                
                this.instTrend.data.datasets[0].data = data;
                this.instTrend.update();
            }
        },

        soundcloud: {
            load: function(u) {
                document.getElementById('sc-iframe').src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(u)}&color=%23ff5500&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true`;
            }
        },

        ai: {
            send: async function() {
                const i = document.getElementById('ai-input'); 
                const v = i.value; 
                if(!v) return;
                const c = document.getElementById('ai-chat');
                c.innerHTML += `<div style="text-align:right; margin-bottom:10px;"><span style="background:#000; color:#fff; padding:8px 12px; border-radius:12px;">${v}</span></div>`;
                i.value = '';

                const API_KEY = "AIzaSyCt1kcwK4nb8PG-2zJTjgg1tym-Aj_0XsI";
                const url = "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateText?key=" + API_KEY;

                try {
                    const resp = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            prompt: { text: v }
                        })
                    });
                    const data = await resp.json();
                    let reply = "AI å›è¦†å¤±æ•—";
                    if(data && data.candidates && data.candidates[0]) {
                        if(data.candidates[0].output) {
                            reply = data.candidates[0].output;
                        } else if(data.candidates[0].safetyAttributes) {
                            reply = "å®‰å…¨é™åˆ¶ï¼š" + JSON.stringify(data.candidates[0].safetyAttributes);
                        }
                    } else if(data && data.error && data.error.message) {
                        reply = "éŒ¯èª¤ï¼š" + data.error.message;
                    }
                    // é¡å¤–è™•ç† entity not found
                    if(reply.includes("Requested entity was not found")) {
                        reply = "éŒ¯èª¤ï¼šRequested entity was not foundï¼ˆè«‹æª¢æŸ¥ model åç¨±æˆ–API Keyï¼‰";
                    }
                    c.innerHTML += `<div style="text-align:left; margin-bottom:10px;"><span style="background:#fff; border:1px solid #eee; padding:8px 12px; border-radius:12px;">${reply}</span></div>`;
                    c.scrollTop = c.scrollHeight;
                } catch(e) {
                    c.innerHTML += `<div style="text-align:left; margin-bottom:10px;"><span style="background:#fff; border:1px solid #eee; padding:8px 12px; border-radius:12px;">AI å›è¦†å¤±æ•—</span></div>`;
                    c.scrollTop = c.scrollHeight;
                }
            }
        },

        // åŒ¯å‡º / åŒ¯å…¥ï¼šæ”¯æ´ File System Access API èˆ‡å‚³çµ±ä¸‹è¼‰/ä¸Šå‚³
        exportData: async function() {
            const dataStr = JSON.stringify(app.data, null, 2);
            // File System Access API
            if(window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'studyflow-data.json',
                        types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(dataStr);
                    await writable.close();
                    alert('åŒ¯å‡ºå®Œæˆ');
                    return;
                } catch(e) { console.error(e); /* fallback to download */ }
            }
            // å‚³çµ±ä¸‹è¼‰
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'studyflow-data.json'; document.body.appendChild(a); a.click();
            a.remove(); URL.revokeObjectURL(url);
            alert('åŒ¯å‡ºå®Œæˆ');
        },

        importFromFile: function(e) {
            const f = e.target.files && e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = function() {
                try {
                    const d = JSON.parse(r.result);
                    // è¦†å¯«è³‡æ–™ï¼Œä¸¦ç¢ºä¿çµæ§‹åŸºæœ¬å­˜åœ¨
                    app.data = d || {};
                    if(!app.data.stats) app.data.stats = { focusToday:0, subjects:{'æ•¸å­¸':0,'è‹±æ–‡':0,'ç‰©ç†':0,'ç¨‹å¼':0,'å…¶ä»–':0} };
                    window.cloudSave();
                    app.refreshAll();
                    alert('åŒ¯å…¥å®Œæˆ');
                } catch(err) {
                    console.error(err);
                    alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                }
            };
            r.readAsText(f);
            e.target.value = '';
        },

        importFromFS: async function() {
            // ä½¿ç”¨ File System Access API é–‹å•Ÿæª”æ¡ˆ
            if(window.showOpenFilePicker) {
                try {
                    const [handle] = await window.showOpenFilePicker({ types:[{ description:'JSON', accept:{ 'application/json':['.json'] } }], multiple:false });
                    const file = await handle.getFile();
                    const text = await file.text();
                    const d = JSON.parse(text);
                    app.data = d || {};
                    if(!app.data.stats) app.data.stats = { focusToday:0, subjects:{'æ•¸å­¸':0,'è‹±æ–‡':0,'ç‰©ç†':0,'ç¨‹å¼':0,'å…¶ä»–':0} };
                    window.cloudSave();
                    app.refreshAll();
                    alert('åŒ¯å…¥å®Œæˆ');
                    return;
                } catch(e) { console.error(e); alert('åŒ¯å…¥å–æ¶ˆæˆ–å¤±æ•—'); return; }
            }
            // å‚³çµ± file input å‚™æ´
            document.getElementById('__import_file').click();
        },

        modals: {
            open: function(t, payload) {
                const m = document.getElementById('modal-content');
                document.getElementById('modal-overlay').classList.add('show');
                document.getElementById('modal-overlay').style.display='flex';
                // çµ±ä¸€åœ¨ modal é ‚éƒ¨åŠ å…¥è¿”å›æŒ‰éˆ•ï¼Œå‘¼å«æ—¢æœ‰ close å‡½å¼
                if(t==='day') {
                    const date = payload;
                    window.app._modalDate = date;
                    window.app._editingEventId = null;
                    const evs = (app.data.events||[]).filter(x=>x.date===date);
                    m.innerHTML = `
                        <div style="display:flex; justify-content:flex-start; margin-bottom:10px;"><button class="back-btn" onclick="app.modals.close()">â† è¿”å›</button></div>
                        <h3 style="margin-bottom:6px;">${date} çš„æ´»å‹•</h3>
                        <div style="max-height:260px; overflow:auto; margin-bottom:10px;">
                            ${evs.length? evs.map(e=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 6px;border-bottom:1px solid #f3f3f3;"><div><div style="font-weight:700">${e.title}</div><div style="font-size:12px;color:#888">${e.time||''}</div></div><div style="display:flex;gap:8px;"><button class="back-btn" onclick="app.events.editStart(${e.id})">ç·¨è¼¯</button><button class="back-btn" onclick="app.events.del(${e.id})" style="background:#FFECEC;color:#B00000">åˆªé™¤</button></div></div>`).join('') : '<div style="color:#888;padding:10px;">æ­¤æ—¥å°šç„¡æ´»å‹•</div>'}
                        </div>
                        <div style="margin-bottom:10px;"><input id="e-title" class="inp" placeholder="æ´»å‹•åç¨±"><input id="e-time" class="inp" placeholder="æ™‚é–“ï¼ˆä¾‹å¦‚ 14:00ï¼‰"></div>
                        <button class="btn-black" style="width:100%" onclick="app.events.save('${date.replace(/'/g, "\\'")}')" onmouseover="this.style.background='#333'" onmouseout="this.style.background='#000'">æ–°å¢ / å„²å­˜</button>
                    `;
                 } else if(t==='task') {
                     m.innerHTML = `
                         <div style="display:flex; justify-content:flex-start; margin-bottom:10px;"><button class="back-btn" onclick="app.modals.close()">â† è¿”å›</button></div>
                         <h3>æ–°å¢ä»»å‹™</h3>
                         <input id="t-title" class="inp" placeholder="å…§å®¹...">
                         <div style="display:flex; gap:8px;">
                             <select id="t-priority" class="inp" style="flex:1; padding:10px;">
                                 <option value="ä¸­">å„ªå…ˆï¼šä¸­</option>
                                 <option value="é«˜">å„ªå…ˆï¼šé«˜</option>
                                 <option value="ä½">å„ªå…ˆï¼šä½</option>
                             </select>
                             <input id="t-est" class="inp" style="width:120px;" type="number" min="0" placeholder="é ä¼°åˆ†é˜">
                         </div>
                         <button class="btn-black" style="width:100%" onclick="app.tasks.add()">æ–°å¢</button>
                     `;
                 } else if(t==='c') {
                     m.innerHTML = `
                         <div style="display:flex; justify-content:flex-start; margin-bottom:10px;"><button class="back-btn" onclick="app.modals.close()">â† è¿”å›</button></div>
                         <h3>æ–°å¢èª²ç¨‹</h3>
                         <input id="c-name" class="inp" placeholder="èª²ç¨‹å">
                         <select id="c-day" class="inp">
                             <option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option>
                         </select>
                         <input id="c-start" class="inp" type="number" placeholder="é–‹å§‹æ™‚é–“(8-20)">
                         <button class="btn-black" style="width:100%" onclick="app.schedule.add()">æ–°å¢</button>
                     `;
                 }
            },
            close: function() {
                document.getElementById('modal-overlay').classList.remove('show');
                setTimeout(()=>document.getElementById('modal-overlay').style.display='none', 300);
            },
            updateDate: function() {
                document.getElementById('date-display').innerText = new Date().toLocaleDateString('zh-TW', {month:'long', day:'numeric', weekday:'long'});
            }
        },

        // --- äº‹ä»¶ç®¡ç† API ---
        events: {
            save: function(date) {
                const title = document.getElementById('e-title') ? document.getElementById('e-title').value.trim() : '';
                const time = document.getElementById('e-time') ? document.getElementById('e-time').value.trim() : '';
                if(!title) return alert('è«‹è¼¸å…¥æ´»å‹•åç¨±');
                if(!app.data.events) app.data.events = [];
                
                // ç·¨è¼¯æ¨¡å¼æˆ–æ–°å¢æ¨¡å¼
                if(window.app._editingEventId) {
                    const ev = app.data.events.find(x=>x.id===window.app._editingEventId);
                    if(ev){ ev.title = title; ev.time = time; }
                    window.app._editingEventId = null;
                } else {
                    app.data.events.push({ id: Date.now(), date, title, time });
                }
                
                window.cloudSave();
                app.cal.render(); // é‡æ–°æ¸²æŸ“æ—¥æ›†
                app.modals.open('day', date); // é‡æ–°æ‰“é–‹è©²æ—¥æœŸåˆ—è¡¨
            },
            del: function(id) {
                const ev = (app.data.events||[]).find(x=>x.id===id);
                if(!ev) return;
                if(confirm('åˆªé™¤æ­¤æ´»å‹•?')) {
                    app.data.events = (app.data.events||[]).filter(x=>x.id!==id);
                    window.cloudSave();
                    app.cal.render();
                    app.modals.open('day', ev.date); // é‡æ–°æ‰“é–‹è©²æ—¥æœŸåˆ—è¡¨
                }
            },
            editStart: function(id) {
                const ev = (app.data.events||[]).find(x=>x.id===id);
                if(!ev) return;
                window.app._editingEventId = id;
                document.getElementById('e-title').value = ev.title;
                document.getElementById('e-time').value = ev.time || '';
                // æ²åˆ°è¡¨å–®
                document.getElementById('e-title').focus();
            }
        }
    };
    window.app.init();

    // æ–°å¢æ™‚é˜è‡ªå‹•æ›´æ–°é‚è¼¯
    function updateLiveClock() {
        const el = document.getElementById('live-clock');
        if (el) {
            const now = new Date();
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            const s = now.getSeconds().toString().padStart(2, '0');
            el.innerText = `${h}:${m}:${s}`;
        }
        // åŒæ­¥æ›´æ–°æ—¥æœŸé¡¯ç¤º
        const dateEl = document.getElementById('date-display');
        if (dateEl) {
            dateEl.innerText = new Date().toLocaleDateString('zh-TW', {month:'long', day:'numeric', weekday:'long'});
        }
    }
    setInterval(updateLiveClock, 1000);
    updateLiveClock();
</script>
</body>
</html>
