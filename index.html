<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StudyFlow Mobile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- 1. 核心變數 --- */
        :root {
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --accent: #000000;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- 2. 電腦版側邊欄 (手機上隱藏) --- */
        .sidebar { width: 260px; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); border-right: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; padding: 32px 20px; z-index: 20; }
        .logo { font-size: 22px; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { display: flex; align-items: center; padding: 14px 16px; color: var(--text-sub); border-radius: 12px; cursor: pointer; transition: 0.2s; font-weight: 600; margin-bottom: 6px; }
        .nav-item:hover { background: rgba(0,0,0,0.04); color: var(--text-main); }
        .nav-item.active { background: #000; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .nav-item i { margin-right: 14px; width: 20px; text-align: center; }

        /* --- 3. 主要內容區 --- */
        .main-content { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .content-wrap { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }
        
        .view-section { display: none; animation: fadeScale 0.3s ease forwards; }
        .view-section.active { display: block; }
        @keyframes fadeScale { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* 卡片與元件樣式 */
        .header h1 { font-size: 32px; font-weight: 800; margin-bottom: 5px; }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border-radius: 20px; padding: 20px; min-height: 110px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: var(--shadow); }
        .sc-val { font-size: 30px; font-weight: 800; }
        .sc-black { background: #1C1C1E; color: white; }
        
        .task-row { display: flex; align-items: center; padding: 16px; background: white; border-radius: 16px; margin-bottom: 12px; box-shadow: var(--shadow); }
        .check-circle { width: 24px; height: 24px; border: 2px solid #C7C7CC; border-radius: 50%; margin-right: 14px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .check-circle.checked { background: #000; border-color: #000; color: white; }
        
        .btn-black { background: #000; color: white; padding: 10px 18px; border-radius: 12px; border: none; font-weight: 600; font-size: 14px; cursor: pointer; }
        .inp { width: 100%; padding: 14px; background: #fff; border: 1px solid #eee; border-radius: 12px; margin-bottom: 12px; font-size: 16px; }

        /* --- 4. 手機版專用 UI (Mobile Styles) --- */
        .mobile-header { display: none; }
        .bottom-nav { display: none; }

        @media (max-width: 768px) {
            /* 強制隱藏電腦版側邊欄 */
            .sidebar { display: none !important; }

            /* 手機頂部導覽列 */
            .mobile-header { 
                display: flex; justify-content: space-between; align-items: center;
                padding: 10px 20px; padding-top: max(10px, var(--safe-top));
                background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
                position: fixed; top: 0; left: 0; width: 100%; z-index: 50;
                border-bottom: 1px solid rgba(0,0,0,0.05);
            }
            .m-logo { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
            .user-avatar { 
                width: 36px; height: 36px; background: #E5E5EA; border-radius: 50%; 
                display: flex; align-items: center; justify-content: center; overflow: hidden; 
            }
            .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

            /* 手機底部導覽列 */
            .bottom-nav { 
                display: flex; justify-content: space-around; align-items: center;
                position: fixed; bottom: 0; left: 0; width: 100%;
                background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
                border-top: 1px solid rgba(0,0,0,0.1);
                padding-bottom: var(--safe-bottom); height: calc(60px + var(--safe-bottom));
                z-index: 100;
            }
            .b-nav-item { 
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                font-size: 10px; color: #999; width: 20%; height: 100%; gap: 3px;
            }
            .b-nav-item.active { color: #000; }
            .b-nav-item i { font-size: 22px; }

            /* 調整內容區 */
            .content-wrap { 
                padding: 20px; 
                padding-top: 80px;
                padding-bottom: 100px;
            }
            
            .stat-grid { grid-template-columns: 1fr 1fr; }
            .dash-split { display: block; } 
            .pomo-card { margin-top: 20px; }
            
            .ai-fab { bottom: 90px; right: 20px; width: 56px; height: 56px; }
            .ai-win { width: 100%; height: 100%; bottom: 0; right: 0; border-radius: 0; transform: translateY(100%); top:0; left:0; }
            .ai-win.open { transform: translateY(0); }
        }

        /* AI 浮動按鈕與視窗 */
        .ai-fab { position: fixed; bottom: 40px; right: 40px; width: 64px; height: 64px; background: #000; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 90; transition: transform 0.2s; }
        .ai-fab:active { transform: scale(0.9); }
        .ai-win { position: fixed; bottom: 120px; right: 40px; width: 380px; height: 500px; background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: translateY(20px) scale(0.95); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; overflow: hidden; }
        .ai-win.open { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 3000; opacity: 0; transition: 0.3s; backdrop-filter: blur(5px); }
        .modal-overlay.show { opacity: 1; }
        .modal { background: white; width: 350px; padding: 24px; border-radius: 24px; transform: scale(0.95); transition: 0.3s; }
        .modal-overlay.show .modal { transform: scale(1); }
    </style>
</head>
<body>

<div class="mobile-header">
    <div class="m-logo"><i class="fa-brands fa-apple"></i> StudyFlow</div>
    <div class="user-avatar" id="m-auth-btn" onclick="app.auth.login()">
        <i class="fa-solid fa-user" style="color:#999;"></i>
    </div>
</div>

<nav class="sidebar">
    <div class="logo"><i class="fa-brands fa-apple"></i> StudyFlow</div>
    <div class="nav-item active" data-target="home" onclick="app.nav('home')"><i class="fa-solid fa-house"></i> 首頁</div>
    <div class="nav-item" data-target="tasks" onclick="app.nav('tasks')"><i class="fa-solid fa-check-circle"></i> 任務</div>
    <div class="nav-item" data-target="schedule" onclick="app.nav('schedule')"><i class="fa-solid fa-calendar-week"></i> 課表</div>
    <div class="nav-item" data-target="calendar" onclick="app.nav('calendar')"><i class="fa-regular fa-calendar"></i> 行事曆</div>
    <div class="nav-item" data-target="stats" onclick="app.nav('stats')"><i class="fa-solid fa-chart-pie"></i> 統計</div>
    
    <div style="margin-top:auto; display:flex; align-items:center; gap:10px; cursor:pointer; padding-top:20px; border-top:1px solid #eee;" onclick="app.auth.login()">
        <div class="user-avatar" id="d-auth-btn" style="width:32px; height:32px;"><i class="fa-solid fa-user" style="color:#999; font-size:14px;"></i></div>
        <div id="u-name-d" style="font-size:14px; font-weight:600;">登入同步</div>
    </div>
</nav>

<main class="main-content">
    <div class="content-wrap">
        
        <div id="home" class="view-section active">
            <div class="header">
                <h1 id="date-display">...</h1>
                <p style="color:#888;">專注當下，積少成多。</p>
            </div>
            
            <div class="stat-grid">
                <div class="stat-card sc-black">
                    <div style="font-size:12px; opacity:0.8;">今日任務</div>
                    <div class="sc-val" id="d-done">0/0</div>
                </div>
                <div class="stat-card">
                    <div style="font-size:12px; color:#888;">待辦事項</div>
                    <div class="sc-val" id="d-todo">0</div>
                </div>
                <div class="stat-card">
                    <div style="font-size:12px; color:#888;">今日專注</div>
                    <div class="sc-val" id="d-focus">0m</div>
                </div>
                <div class="stat-card">
                    <div style="font-size:12px; color:#888;">連續登入</div>
                    <div class="sc-val" id="d-hist-len">0天</div>
                </div>
            </div>

            <div class="dash-split">
                <div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <h3>近期任務</h3>
                        <button class="btn-black" style="padding:8px 14px;" onclick="app.modals.open('task')">＋</button>
                    </div>
                    <div id="dash-tasks"></div>
                </div>
                
                <div class="pomo-card" style="background:white; padding:30px; border-radius:24px; text-align:center; box-shadow:var(--shadow);">
                    <div style="font-size:12px; font-weight:700; color:#ccc; letter-spacing:1px; margin-bottom:15px;">FOCUS TIMER</div>
                    <div style="position:relative; width:180px; height:180px; margin:0 auto;">
                        <svg style="transform:rotate(-90deg); width:100%; height:100%;" viewBox="0 0 240 240">
                            <circle cx="120" cy="120" r="110" fill="none" stroke="#f5f5f7" stroke-width="12"></circle>
                            <circle id="pomo-ring" cx="120" cy="120" r="110" fill="none" stroke="#000" stroke-width="12" stroke-dasharray="691" stroke-dashoffset="0" stroke-linecap="round"></circle>
                        </svg>
                        <div id="timer-display" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:48px; font-weight:800;">25:00</div>
                    </div>
                    <div style="display:flex; gap:15px; justify-content:center; margin-top:20px;">
                         <button class="btn-black" onclick="app.timer.toggle()" id="btn-play" style="width:60px; height:60px; border-radius:50%; font-size:20px;"><i class="fa-solid fa-play"></i></button>
                         <button style="width:50px; height:50px; border-radius:50%; background:#f5f5f7; border:none; cursor:pointer;" onclick="app.timer.reset()"><i class="fa-solid fa-rotate-left"></i></button>
                    </div>
                    <div id="pomo-subjs" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:20px;"></div>
                </div>
            </div>
        </div>

        <div id="tasks" class="view-section">
            <div class="header"><h1>任務清單</h1></div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input class="inp" style="margin:0;" placeholder="搜尋..." oninput="app.tasks.setSearch(this.value)">
                <button class="btn-black" onclick="app.modals.open('task')">＋</button>
            </div>
            <div id="full-task-list"></div>
        </div>

        <div id="schedule" class="view-section">
            <div class="header"><h1>我的課表</h1></div>
            <div style="background:white; border-radius:20px; overflow-x:auto; padding-bottom:10px; box-shadow:var(--shadow);">
                <div id="sch-grid" style="display:grid; grid-template-columns: 50px repeat(7, minmax(80px, 1fr)); min-width:600px;"></div>
            </div>
        </div>

        <div id="calendar" class="view-section">
            <div class="header"><h1>行事曆</h1></div>
            <div style="background:white; padding:20px; border-radius:20px; box-shadow:var(--shadow);">
                 <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h2 id="cal-title" style="font-size:20px;">...</h2>
                    <div><button class="btn-black" style="padding:6px 12px;" onclick="app.cal.move(-1)"><</button> <button class="btn-black" style="padding:6px 12px;" onclick="app.cal.move(1)">></button></div>
                </div>
                <div id="cal-body" style="display:grid; grid-template-columns:repeat(7,1fr); gap:8px;"></div>
            </div>
        </div>

        <div id="stats" class="view-section">
            <div class="header"><h1>學習統計</h1></div>
            <div style="background:white; padding:20px; border-radius:20px; margin-bottom:20px; box-shadow:var(--shadow);">
                <h3>專注趨勢</h3>
                <div style="height:250px;"><canvas id="chartTrend"></canvas></div>
            </div>
            <div style="background:white; padding:20px; border-radius:20px; box-shadow:var(--shadow);">
                <h3>科目分佈</h3>
                <div style="height:250px; position:relative;"><canvas id="chartSubj"></canvas></div>
            </div>
        </div>

    </div>
</main>

<nav class="bottom-nav">
    <div class="b-nav-item active" data-target="home" onclick="app.nav('home')"><i class="fa-solid fa-house"></i> 首頁</div>
    <div class="b-nav-item" data-target="tasks" onclick="app.nav('tasks')"><i class="fa-solid fa-list-check"></i> 任務</div>
    <div class="b-nav-item" data-target="schedule" onclick="app.nav('schedule')"><i class="fa-solid fa-calendar-week"></i> 課表</div>
    <div class="b-nav-item" data-target="calendar" onclick="app.nav('calendar')"><i class="fa-regular fa-calendar"></i> 行事曆</div>
    <div class="b-nav-item" data-target="stats" onclick="app.nav('stats')"><i class="fa-solid fa-chart-pie"></i> 統計</div>
</nav>

<div class="ai-fab" onclick="document.getElementById('ai-win').classList.add('open')"><i class="fa-solid fa-robot"></i></div>

<div class="ai-win" id="ai-win">
    <div style="padding:16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:#FAFAFA;">
        <div style="font-weight:700;">AI 學習助手 <span onclick="app.ai.resetKey()" style="font-size:12px; color:#007AFF; margin-left:10px; cursor:pointer;">重設Key</span></div>
        <i class="fa-solid fa-xmark" style="padding:5px; cursor:pointer;" onclick="document.getElementById('ai-win').classList.remove('open')"></i>
    </div>
    <div id="ai-chat" style="flex:1; padding:20px; overflow-y:auto; background:#fff;"></div>
    <div style="padding:16px; border-top:1px solid #eee; background:#fff; display:flex; gap:10px;">
        <input id="ai-input" class="inp" style="margin:0; flex:1;" placeholder="問問 AI..." onkeypress="if(event.key==='Enter') app.ai.send()">
        <button class="btn-black" style="width:auto; padding:0 16px;" onclick="app.ai.send()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay"><div class="modal" id="modal-content"></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD9LW-VQo8ejMq1dYCC9WhdmakUXR17q9I",
      authDomain: "studydatabase-29aaf.firebaseapp.com",
      databaseURL: "https://studydatabase-29aaf-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "studydatabase-29aaf",
      storageBucket: "studydatabase-29aaf.firebasestorage.app",
      messagingSenderId: "781290296072",
      appId: "1:781290296072:web:4a8894785a0cd4cb00d2bd",
      measurementId: "G-F7VLYF7P3C"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        getRedirectResult(auth).then((result) => { if(result) console.log("Login success"); }).catch((e) => console.error(e));

        onAuthStateChanged(auth, (user) => {
            window.app.currentUser = user;
            window.app.updateAuthUI(user);
            if (user) {
                onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                    if (docSnap.exists()) {
                        window.app.data = { ...window.app.data, ...docSnap.data() };
                        window.app.refreshAll();
                    } else window.cloudSave(window.app.data);
                });
            }
        });

        window.app.auth = {
            login: () => {
                if(window.app.currentUser) { if(confirm('登出帳號？')) signOut(auth); } 
                else {
                    const provider = new GoogleAuthProvider();
                    // 優先嘗試彈出視窗 (Popup)
                    signInWithPopup(auth, provider).catch((error) => {
                        console.log("Popup blocked or failed, falling back to redirect.", error);
                        // 如果彈出失敗 (例如在某些 APP 內嵌瀏覽器)，則切換為跳轉 (Redirect)
                        signInWithRedirect(auth, provider);
                    });
                }
            }
        };
        window.cloudSave = async (data) => {
            localStorage.setItem('sf_fixed_mobile', JSON.stringify(data));
            if (db && window.app.currentUser) try { await setDoc(doc(db, "users", window.app.currentUser.uid), data); } catch(e){}
        };
    } catch(e) {
        console.warn("Firebase Local Mode");
        window.cloudSave = async (data) => { localStorage.setItem('sf_fixed_mobile', JSON.stringify(data)); };
        window.app.auth = { login: () => alert("本機模式無法登入雲端，但資料會保存在此裝置。") };
    }
</script>

<script>
    window.app = window.app || {};
    window.app = {
        ...window.app, 
        currentUser: null,
        data: { tasks: [], courses: [], stats: { focusToday: 0, subjects: {'數學':0,'英文':0,'物理':0,'程式':0,'其他':0} }, history: [], lastActiveDate: '', apiKey: '' },
        viewState: { search: '', filter: 'all' },

        init: function() {
            const local = localStorage.getItem('sf_fixed_mobile');
            if(local) { const p = JSON.parse(local); this.data = { ...this.data, ...p }; if(!this.data.history) this.data.history=[]; }
            const savedKey = localStorage.getItem('studyflow_gemini_key');
            if(savedKey) this.data.apiKey = savedKey;

            this.checkDailyReset();
            this.updateDate();
            this.timer.init();
            this.chart.init();
            this.refreshAll();
            document.getElementById('modal-overlay').addEventListener('click', (e)=>{if(e.target.id==='modal-overlay')app.modals.close()});
        },

        checkDailyReset: function() {
            const todayStr = new Date().toISOString().split('T')[0];
            if (this.data.lastActiveDate !== todayStr) {
                if (this.data.lastActiveDate) {
                    this.data.history.push({ date: this.data.lastActiveDate, focus: this.data.stats.focusToday, subjects: {...this.data.stats.subjects} });
                    if(this.data.history.length > 7) this.data.history.shift();
                }
                this.data.stats.focusToday = 0;
                this.data.stats.subjects = {'數學':0,'英文':0,'物理':0,'程式':0,'其他':0};
                this.data.lastActiveDate = todayStr;
                this.save();
            }
        },

        refreshAll: function() {
            this.tasks.render();
            this.schedule.render();
            this.cal.render();
            this.stats.render();
            if(this.chart.instSubj) this.chart.updateSubj();
            if(this.chart.instTrend) this.chart.updateTrend();
        },
        save: function() { if(window.cloudSave) window.cloudSave(this.data); this.refreshAll(); },
        updateDate: function() { document.getElementById('date-display').innerText = new Date().toLocaleDateString('zh-TW', {month:'long', day:'numeric', weekday:'long'}); },
        updateAuthUI: function(user) {
            const html = user ? `<img src="${user.photoURL}">` : `<i class="fa-solid fa-user" style="color:#999;font-size:14px;"></i>`;
            const mBtn = document.getElementById('m-auth-btn'); if(mBtn) mBtn.innerHTML = html;
            const dBtn = document.getElementById('d-auth-btn'); if(dBtn) dBtn.innerHTML = html;
            const uName = document.getElementById('u-name-d'); if(uName) uName.innerText = user ? user.displayName : "登入同步";
        },
        nav: function(id) {
            document.querySelectorAll('.view-section').forEach(v=>v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item, .b-nav-item').forEach(n => {
                n.classList.remove('active');
                if(n.dataset.target === id) n.classList.add('active');
            });
        },
        
        tasks: {
            add: function() {
                const title=document.getElementById('t-title').value, subj=document.getElementById('t-subj').value;
                if(!title) return;
                if(!app.data.tasks) app.data.tasks=[];
                app.data.tasks.unshift({id:Date.now(), title, subj:subj||'一般', done:false, date: new Date().toISOString().split('T')[0]});
                app.save(); app.modals.close();
            },
            toggle: function(id) { const t = app.data.tasks.find(x=>x.id===id); if(t) { t.done=!t.done; if(t.done) confetti({origin:{x:0.5, y:0.5}, colors:['#000','#333']}); } app.save(); },
            setSearch: function(s) { app.viewState.search = s.toLowerCase(); this.render(); },
            del: function(id) { if(confirm('刪除?')){ app.data.tasks = app.data.tasks.filter(x=>x.id!==id); app.save(); } },
            render: function() {
                const all = app.data.tasks || [];
                const doneCount = all.filter(x=>x.done).length;
                document.getElementById('d-done').innerText = `${doneCount}/${all.length}`;
                document.getElementById('d-todo').innerText = all.length - doneCount;
                const mkItem = (t) => `
                    <div class="task-row">
                        <div class="check-circle ${t.done?'checked':''}" onclick="app.tasks.toggle(${t.id})"><i class="fa-solid fa-check" style="color:white;font-size:10px;display:${t.done?'block':'none'}"></i></div>
                        <div style="flex:1;">
                            <div style="font-weight:600; text-decoration:${t.done?'line-through':''}; color:${t.done?'#999':''}; font-size:15px;">${t.title}</div>
                            <div style="font-size:12px; color:#999; margin-top:2px;">${t.subj}</div>
                        </div>
                        <i class="fa-regular fa-trash-can" style="color:#ddd;cursor:pointer;padding:10px;" onclick="app.tasks.del(${t.id})"></i>
                    </div>`;
                document.getElementById('dash-tasks').innerHTML = all.filter(x=>!x.done).slice(0,3).map(mkItem).join('') || '<div style="color:#999;text-align:center;padding:20px;font-size:14px;">暫無待辦</div>';
                let list = all.filter(t => t.title.toLowerCase().includes(app.viewState.search));
                document.getElementById('full-task-list').innerHTML = list.map(mkItem).join('');
            }
        },

        timer: {
            time: 1500, max: 1500, int: null, active: false, subj: '數學',
            init: function() {
                document.getElementById('pomo-subjs').innerHTML = ['數學','英文','物理','程式','其他'].map(s => `<span style="padding:6px 14px; border-radius:20px; font-size:13px; background:${s===this.subj?'#000':'#F2F2F7'}; color:${s===this.subj?'#fff':'#666'}; cursor:pointer;" onclick="app.timer.setSubj('${s}')">${s}</span>`).join('');
                this.draw();
            },
            setSubj: function(s) { this.subj=s; this.init(); },
            toggle: function() {
                if(this.active) { clearInterval(this.int); this.active=false; document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-play"></i>'; }
                else { this.active=true; document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-pause"></i>'; this.int=setInterval(()=>{ this.time--; this.draw(); if(this.time<=0)this.finish(); },1000); }
            },
            finish: function() { this.saveTime(Math.floor(this.max/60)); confetti(); alert('專注完成！'); this.reset(); },
            reset: function() { clearInterval(this.int); this.active=false; this.time=this.max; document.getElementById('btn-play').innerHTML='<i class="fa-solid fa-play"></i>'; this.draw(); },
            draw: function() {
                const m=Math.floor(this.time/60).toString().padStart(2,'0'), s=(this.time%60).toString().padStart(2,'0');
                document.getElementById('timer-display').innerText=`${m}:${s}`;
                const off = 691 - (this.time/this.max)*691;
                document.getElementById('pomo-ring').style.strokeDashoffset = off;
            },
            saveTime: function(m) {
                app.data.stats.focusToday += m;
                if(!app.data.stats.subjects[this.subj]) app.data.stats.subjects[this.subj] = 0;
                app.data.stats.subjects[this.subj] += m;
                app.save();
            }
        },

        schedule: {
            render: function() {
                const g = document.getElementById('sch-grid');
                g.innerHTML = `<div></div>` + ['一','二','三','四','五','六','日'].map(d=>`<div style="padding:10px;text-align:center;font-size:12px;color:#888;">週${d}</div>`).join('');
                const tc = document.createElement('div'); for(let i=8;i<=20;i++) tc.innerHTML+=`<div style="height:80px;border-bottom:1px solid #eee;text-align:center;padding:10px;color:#999;font-size:10px;">${i}</div>`; g.appendChild(tc);
                for(let d=1;d<=7;d++) {
                    const col = document.createElement('div'); col.style.position='relative'; col.style.borderRight='1px solid #f5f5f7';
                    for(let h=8;h<=20;h++) { const s=document.createElement('div'); s.style.height='80px'; s.style.borderBottom='1px solid #f9f9f9'; s.onclick=()=>app.modals.open('course',{day:d,start:h}); col.appendChild(s); }
                    (app.data.courses||[]).filter(c=>c.day===d).forEach(c=>{
                        const b=document.createElement('div'); b.className='c-block'; b.style.cssText=`position:absolute;left:2px;right:2px;padding:5px;border-radius:6px;font-size:11px;font-weight:600;background:#333;color:white;cursor:pointer;top:${(c.start-8)*80}px;height:${(c.dur*80)-4}px;overflow:hidden;`;
                        b.innerHTML=`<div>${c.name}</div>`; b.onclick=(e)=>{e.stopPropagation();if(confirm('刪除?')){app.data.courses=app.data.courses.filter(x=>x.id!==c.id);app.save();}};
                        col.appendChild(b);
                    });
                    g.appendChild(col);
                }
            },
            add: function() {
                const n=document.getElementById('c-name').value; if(!n) return;
                if(!app.data.courses)app.data.courses=[];
                app.data.courses.push({id:Date.now(), name:n, day:parseInt(document.getElementById('c-day').value), start:parseFloat(document.getElementById('c-start').value), dur:parseFloat(document.getElementById('c-dur').value)});
                app.save(); app.modals.close();
            }
        },

        cal: {
            d:new Date(),
            move:function(n){this.d.setMonth(this.d.getMonth()+n);this.render();},
            render:function(){
                const y=this.d.getFullYear(), m=this.d.getMonth();
                document.getElementById('cal-title').innerText=`${y}年 ${m+1}月`;
                const g=document.getElementById('cal-body'); g.innerHTML='';
                ['日','一','二','三','四','五','六'].forEach(h=>g.innerHTML+=`<div style="text-align:center;font-size:12px;color:#999;padding:10px 0;">${h}</div>`);
                const fd=new Date(y,m,1).getDay(), dim=new Date(y,m+1,0).getDate();
                for(let i=0;i<fd;i++)g.innerHTML+=`<div></div>`;
                for(let i=1;i<=dim;i++){
                    const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const has=(app.data.tasks||[]).some(t=>t.date===ds);
                    const isToday = ds===new Date().toISOString().split('T')[0];
                    g.innerHTML+=`<div style="aspect-ratio:1; display:flex; flex-direction:column; align-items:center; justify-content:center; border-radius:10px; background:${isToday?'#000':'transparent'}; color:${isToday?'#fff':'#333'}; position:relative; font-size:14px;">${i} ${has?'<div style="width:4px;height:4px;border-radius:50%;background:currentColor;opacity:0.5;position:absolute;bottom:4px;"></div>':''}</div>`;
                }
            }
        },

        ai: {
            send: async function() {
                const i=document.getElementById('ai-input'), t=i.value; if(!t)return;
                const chatBox=document.getElementById('ai-chat'); 
                if (!app.data.apiKey || app.data.apiKey.length < 10) {
                    const newKey = prompt("請輸入 Gemini API Key：");
                    if(newKey && newKey.trim().length > 10) { app.data.apiKey = newKey.trim(); localStorage.setItem('studyflow_gemini_key', app.data.apiKey); } 
                    else { alert("請輸入有效的 API Key"); return; }
                }
                chatBox.innerHTML+=`<div style="background:#000;color:white;padding:12px;border-radius:12px;margin-bottom:10px;align-self:flex-end;max-width:85%;margin-left:auto;">${t}</div>`; 
                i.value=''; chatBox.scrollTop = chatBox.scrollHeight;
                const loadId = 'load-'+Date.now();
                chatBox.innerHTML+=`<div id="${loadId}" style="color:#999;font-size:13px;margin-bottom:10px;">思考中...</div>`;

                try {
                    const ctx = `我是學習助手。目前數據: 今日專注 ${app.data.stats.focusToday}分。科目: ${JSON.stringify(app.data.stats.subjects)}。歷史: ${JSON.stringify(app.data.history)}。使用者問: ${t}`;
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${app.data.apiKey}`, { 
                        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:ctx}]}]}) 
                    });
                    const d = await r.json(); document.getElementById(loadId).remove();
                    if (d.error) { chatBox.innerHTML+=`<div style="color:red;padding:10px;">Error: ${d.error.message}</div>`; if(d.error.message.includes('Key')) { localStorage.removeItem('studyflow_gemini_key'); app.data.apiKey=''; } } 
                    else chatBox.innerHTML+=`<div style="background:#f0f0f5;padding:14px;border-radius:12px;margin-bottom:10px;line-height:1.5;max-width:90%;">${marked.parse(d.candidates[0].content.parts[0].text)}</div>`;
                } catch(e) { document.getElementById(loadId).remove(); chatBox.innerHTML+='<div style="color:red;">連線錯誤</div>'; }
                chatBox.scrollTop = chatBox.scrollHeight;
            },
            resetKey: function() { localStorage.removeItem('studyflow_gemini_key'); app.data.apiKey = ''; alert("Key 已清除"); }
        },

        stats: { render: function() { document.getElementById('d-focus').innerText = app.data.stats.focusToday+'m'; document.getElementById('d-hist-len').innerText = (app.data.history ? app.data.history.length : 0) + '天'; } },

        modals: {
            el: document.getElementById('modal-content'), ov: document.getElementById('modal-overlay'),
            open: function(type, data={}) {
                this.ov.style.display='flex'; setTimeout(()=>this.ov.classList.add('show'), 10);
                if(type==='task') this.el.innerHTML = `<h3>新增任務</h3><input id="t-title" class="inp" placeholder="標題"><input id="t-subj" class="inp" placeholder="科目"><button class="btn-black" style="width:100%" onclick="app.tasks.add()">新增</button>`;
                else this.el.innerHTML = `<h3>新增課程</h3><input id="c-name" class="inp" placeholder="名稱"><select id="c-day" class="inp"><option value="1" ${data.day==1?'selected':''}>週一</option><option value="2" ${data.day==2?'selected':''}>週二</option><option value="3" ${data.day==3?'selected':''}>週三</option><option value="4" ${data.day==4?'selected':''}>週四</option><option value="5" ${data.day==5?'selected':''}>週五</option></select><input id="c-start" type="number" class="inp" placeholder="開始(8-20)" value="${data.start||''}" ><input id="c-dur" type="number" class="inp" value="1" placeholder="時長"><button class="btn-black" style="width:100%" onclick="app.schedule.add()">保存</button>`;
            },
            close: function() { this.ov.classList.remove('show'); setTimeout(()=>this.ov.style.display='none', 200); }
        },

        chart: {
            instSubj: null, instTrend: null,
            init: function() {
                this.instTrend = new Chart(document.getElementById('chartTrend'), { type:'line', data:{labels:['D-6','D-5','D-4','D-3','D-2','昨天','今天'],datasets:[{label:'分',data:[0,0,0,0,0,0,0],borderColor:'#000',tension:0.4,fill:true,backgroundColor:'rgba(0,0,0,0.05)'}]}, options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true}},maintainAspectRatio:false} });
                this.updateSubj(); this.updateTrend();
            },
            updateTrend: function() { if(!this.instTrend) return; const h = (app.data.history || []).map(x=>x.focus); const full = [...h, app.data.stats.focusToday]; while(full.length<7)full.unshift(0); this.instTrend.data.datasets[0].data = full.slice(-7); this.instTrend.update(); },
            updateSubj: function() {
                const ctx = document.getElementById('chartSubj'); if(this.instSubj) this.instSubj.destroy();
                const d = Object.values(app.data.stats.subjects), isEmpty = d.every(v=>v===0);
                this.instSubj = new Chart(ctx, { type:'doughnut', data:{labels:Object.keys(app.data.stats.subjects),datasets:[{data:isEmpty?[1]:d,backgroundColor:isEmpty?['#eee']:['#000','#333','#666','#999','#ccc'],borderWidth:0}]}, options:{cutout:'70%',plugins:{legend:{position:'right',labels:{boxWidth:10,font:{size:11}}}},maintainAspectRatio:false}});
            }
        }
    };
    window.app.init();
</script>
</body>
</html>
